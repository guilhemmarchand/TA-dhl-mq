<dashboard theme="dark" script="TA-dhl-mq:manage_pending_batches_v2.js,TA-dhl-mq:token_buttons.js,TA-dhl-mq:token_buttons.js">
  <label>Manage pending batches</label>
  <row>
    <panel>
      <single>
        <search id="baseSingle">
          <query>| inputlookup mq_publish_backlog where (status="pending" AND validation_required=1) | stats dc(batch_uuid) as dcount</query>
        </search>
        <option name="colorBy">value</option>
        <option name="colorMode">block</option>
        <option name="drilldown">all</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x53a051","0xf1813f"]</option>
        <option name="rangeValues">[0]</option>
        <option name="showSparkline">1</option>
        <option name="showTrendIndicator">1</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
        <option name="trendColorInterpretation">standard</option>
        <option name="trendDisplayMode">absolute</option>
        <option name="underLabel">BATCHES WAITING FOR APPROVAL</option>
        <option name="unitPosition">after</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <html>
          <div style="text-align: center;" class="refresh-button">
              <button class="btn btn-default btn-primary pull-left">
            <span class="glyphicon glyphicon-remove"/> Refresh</button>
          </div>
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>Click on a pending batch to validate the submission and free the publication of the associated messages</title>
      <input type="dropdown" token="batch_uuid" searchWhenChanged="true">
        <label>batch_uuid</label>
        <choice value="*">ALL</choice>
        <initialValue>*</initialValue>
        <default>*</default>
        <fieldForLabel>batch_uuid</fieldForLabel>
        <fieldForValue>batch_uuid</fieldForValue>
        <prefix>batch_uuid="</prefix>
        <suffix>"</suffix>
        <search id="populateSearch">
          <query>| inputlookup mq_publish_backlog where (status="pending" AND validation_required=1) | stats count by batch_uuid | fields batch_uuid | sort limit=10000 batch_uuid</query>
        </search>
      </input>
      <table rejects="$show_null_results$">
        <search id="baseTable">
          <query>| inputlookup mq_publish_backlog where (status="pending" AND validation_required=1) | search $batch_uuid$
| stats min(ctime) as ctime, max(mtime) as mtime, values(region) as region, values(appname) as appname, values(validation_required) as validation_required, count, values(manager) as manager, values(queue) as queue, values(user) as requester by batch_uuid
| eval ctime=strftime(ctime, "%c"), mtime=strftime(mtime, "%c")
| fields batch_uuid, ctime, mtime, *</query>
          <done>
              <condition match="$job.resultCount$ == 0">
                  <set token="show_null_results">true</set>
              </condition>
              <condition>
                  <unset token="show_null_results"></unset>
              </condition>
          </done>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">row</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <drilldown>
          <set token="showactions">True</set>
          <unset token="validatebatch"></unset>
          <unset token="cancelbatch"></unset>
          <set token="target_batch_uuid">$row.batch_uuid$</set>
        </drilldown>
      </table>
      <html depends="$show_null_results$">
        <h2 style="text-align: center; font-style: italic;">There are no pending batches currently, or the selected batch was processed (click on the refresh button)</h2>
      </html>
    </panel>
  </row>

  <row depends="$showactions$">
    <panel>
      <html>
          <div style="display: flex;">
            <div style="text-align: center; margin-right: 20px;" class="active-button">
                <button class="btn btn-default btn-primary pull-center" data-token-name="validatebatch" data-alt-label="Click on the refresh button" data-token-value="true">
              <span class="glyphicon glyphicon-remove"/> Validate this batch</button>
            </div>
            <br />
            <div style="text-align: center; margin-right: 20px;" class="active-button">
                <button class="btn btn-default btn-primary pull-center" data-token-name="cancelbatch" data-alt-label="Click on the refresh button" data-token-value="true">
              <span class="glyphicon glyphicon-remove"/> Cancel this batch</button>
            </div>
          </div>
      </html>
    </panel>
  </row>

  <row depends="$showactions$ $validatebatch$">
    <panel>
      <title>Activation result:</title>
      <table>
        <search depends="$validatebatch$ $target_batch_uuid$">
          <query>| managebatch batch_uuid="$target_batch_uuid$"
| table action, batch_uuid, region, appname, validation_required, count, manager, queue
| eval action=case(action="success", action . " ✅", action="*_failure", action . " ⭕")</query>
        </search>
      </table>
    </panel>
  </row>

  <row depends="$showactions$ $cancelbatch$">
    <panel>
      <title>Cancel result:</title>
      <table>
        <search depends="$cancelbatch$ $target_batch_uuid$">
          <query>| inputlookup mq_publish_backlog where (status="pending" AND batch_uuid="$target_batch_uuid$") | eval key=_key
| eval status="canceled"
| outputlookup append=t key_field=key mq_publish_backlog
| stats values(status) as status, values(batch_uuid) as batch_uuid
</query>
        </search>
      </table>
    </panel>
  </row>

</dashboard>