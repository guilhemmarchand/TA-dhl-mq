

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Deployment and base configuration &mdash; TA-dhl-mq 1 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="MQ managers Configuration" href="configuration.html" />
    <link rel="prev" title="Requirements" href="requirements.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> TA-dhl-mq
          

          
            
            <img src="_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="compatibility.html">Compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="requirements.html">Requirements</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Deployment and base configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#bearer-token-requirements">Bearer Token requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="#deployment-of-the-add-on-on-the-search-head-layer">Deployment of the Add-on on the Search Head layer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#deploy-the-add-on-to-the-shcluster-deployer-and-push-the-shc-bundle">Deploy the Add-on to the shcluster deployer and push the SHC bundle</a></li>
<li class="toctree-l3"><a class="reference internal" href="#upgrade-the-add-on-on-on-the-shc">Upgrade the Add-on on on the SHC</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration-on-the-search-head-layer">Configuration on the Search Head layer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#enabling-the-passthrough-mode">Enabling the passthrough mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configure-the-max-number-of-retry">Configure the max number of retry</a></li>
<li class="toctree-l4"><a class="reference internal" href="#kvstore-eviction-policy">KVstore eviction policy</a></li>
<li class="toctree-l4"><a class="reference internal" href="#kvstore-retention">KVstore retention</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#deployment-of-the-add-on-on-heavy-forwarders">Deployment of the Add-on on Heavy Forwarders</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#mqclient-librairies-installation">MQClient librairies installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#q-command-installation">Q command installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#kvstore-instance">KVstore instance</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bearer-token">Bearer token</a></li>
<li class="toctree-l3"><a class="reference internal" href="#high-availability-group">High availability group</a></li>
<li class="toctree-l3"><a class="reference internal" href="#kvstore-search-filters">KVstore search filters</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">MQ managers Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="high_availability.html">High Availability</a></li>
<li class="toctree-l1"><a class="reference internal" href="rbac.html">Role Based Access Control (RBAC)</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="userguide.html">User guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="troubleshoot.html">Troubleshoot</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="releasenotes.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Development and build process</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">TA-dhl-mq</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Deployment and base configuration</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/deployment.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="deployment-and-base-configuration">
<h1>Deployment and base configuration<a class="headerlink" href="#deployment-and-base-configuration" title="Permalink to this headline">¶</a></h1>
<div class="section" id="bearer-token-requirements">
<h2>Bearer Token requirements<a class="headerlink" href="#bearer-token-requirements" title="Permalink to this headline">¶</a></h2>
<p><strong>A bearer token must be created on the SHC which is going to be used by the Heavy Forwarders to perform their various operations on different KVstore collections part of the TA.</strong></p>
<p>The bearer token must match a service account user that is a member of the builtin role:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mqsubmission_superadmin</span></code></p></li>
</ul>
</div>
<div class="section" id="deployment-of-the-add-on-on-the-search-head-layer">
<h2>Deployment of the Add-on on the Search Head layer<a class="headerlink" href="#deployment-of-the-add-on-on-the-search-head-layer" title="Permalink to this headline">¶</a></h2>
<p>The Add-on is designed to be running on Splunk Search Heads, either in a standalone more or in a Search Head Cluster context.</p>
<p>The entire configuration can be and should be achieved via the builtin user interface of the Add-on.</p>
<div class="section" id="deploy-the-add-on-to-the-shcluster-deployer-and-push-the-shc-bundle">
<h3>Deploy the Add-on to the shcluster deployer and push the SHC bundle<a class="headerlink" href="#deploy-the-add-on-to-the-shcluster-deployer-and-push-the-shc-bundle" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Respecting Splunk deployment standards, extract the current release in the shcluster deployer</p></li>
<li><p>Push the SHC bundle and monitor for a potential rolling restart of the SHC members</p></li>
</ul>
</div>
<div class="section" id="upgrade-the-add-on-on-on-the-shc">
<h3>Upgrade the Add-on on on the SHC<a class="headerlink" href="#upgrade-the-add-on-on-on-the-shc" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Upgrade is performed in the same way as the initial deployment, extract, and push the bundle</p></li>
<li><p>All configuration items are preserved automatically on the SHC</p></li>
</ul>
</div>
<div class="section" id="configuration-on-the-search-head-layer">
<h3>Configuration on the Search Head layer<a class="headerlink" href="#configuration-on-the-search-head-layer" title="Permalink to this headline">¶</a></h3>
<div class="section" id="enabling-the-passthrough-mode">
<h4>Enabling the passthrough mode<a class="headerlink" href="#enabling-the-passthrough-mode" title="Permalink to this headline">¶</a></h4>
<p>The most important thing to setup on the Search Head layer is to enable the <strong>passthrough mode</strong>, which instructs the application to behave as the front-end rather than the back-end.</p>
<p><strong>To achieve this, open the configuration UI and click on the enable passthrough mode button then save:</strong></p>
<a class="reference internal image-reference" href="_images/enable_passthrough.png"><img alt="enable_passthrough.png" class="align-center" src="_images/enable_passthrough.png" style="width: 600px;" /></a>
</div>
<div class="section" id="configure-the-max-number-of-retry">
<h4>Configure the max number of retry<a class="headerlink" href="#configure-the-max-number-of-retry" title="Permalink to this headline">¶</a></h4>
<p>When a message cannot be successfully submitted to IBM MQ, the application can re-attempt automatically to publish the message again until it has reached a certain amount of failures.</p>
<p>The maximal number of failures can defined on the Search Head layer within the UI:</p>
<a class="reference internal image-reference" href="_images/max_attempts.png"><img alt="max_attempts.png" class="align-center" src="_images/max_attempts.png" style="width: 600px;" /></a>
<p>In a nutshell:</p>
<ul class="simple">
<li><p>When the message is submitted, its status is pending</p></li>
<li><p>If the message cannot be submitted successfully, its status is set to temporary_failure</p></li>
<li><p>A field called “no_max_retry” contains the maximal amount of attempts configured, and a field called “no_attempts” the number of attempts that was performed until now</p></li>
<li><p>Once no_attempts reaches no_max_retry, the message status is set to permanent_failure</p></li>
<li><p>Finally, when the message reaches its storage retention, it is purged from the KVstore automatically</p></li>
</ul>
</div>
<div class="section" id="kvstore-eviction-policy">
<h4>KVstore eviction policy<a class="headerlink" href="#kvstore-eviction-policy" title="Permalink to this headline">¶</a></h4>
<a class="reference internal image-reference" href="_images/kvstore_eviction_policy.png"><img alt="kvstore_eviction_policy.png" class="align-center" src="_images/kvstore_eviction_policy.png" style="width: 600px;" /></a>
<p>The policy defines the Add-on action when the messages reach the following statuses</p>
<ul class="simple">
<li><p>success</p></li>
<li><p>permanent_failure</p></li>
<li><p>canceled</p></li>
</ul>
<p>If:</p>
<ul class="simple">
<li><p>Preserve: the message remains in the KVstore until it reaches its retention</p></li>
<li><p>Delete: the message is immediately deleted from the KVstore</p></li>
</ul>
</div>
<div class="section" id="kvstore-retention">
<h4>KVstore retention<a class="headerlink" href="#kvstore-retention" title="Permalink to this headline">¶</a></h4>
<a class="reference internal image-reference" href="_images/kvstore_retention.png"><img alt="kvstore_retention.png" class="align-center" src="_images/kvstore_retention.png" style="width: 600px;" /></a>
<p>This defines the maximal age of a given message stored in the KVstore, in hours.</p>
<p>When the message reaches this value, it becomes a candidate for deletion from the KVstore.</p>
</div>
</div>
</div>
<div class="section" id="deployment-of-the-add-on-on-heavy-forwarders">
<h2>Deployment of the Add-on on Heavy Forwarders<a class="headerlink" href="#deployment-of-the-add-on-on-heavy-forwarders" title="Permalink to this headline">¶</a></h2>
<p>In the context of the Add-on, Heavy Forwarders are considered as consumers, and will potentially be consuming pending messages stored in the KVstore of the SHC using different concepts of high availability and scope. (applications and regions)</p>
<p>The first step is to deploy the MQClient librairies, then the q command, the Add-on itself and finally its configuration.</p>
<div class="section" id="mqclient-librairies-installation">
<h3>MQClient librairies installation<a class="headerlink" href="#mqclient-librairies-installation" title="Permalink to this headline">¶</a></h3>
<p><strong>For each Splunk Heavy Forwarder that will handle the submission of messages to MQ Series, the first requirement is the deployment of the IBM MQClient which can be downloaded here:</strong></p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%2FWebSphere&amp;product=ibm/WebSphere/WebSphere+MQ&amp;release=9.2.1&amp;platform=All&amp;function=fixId&amp;fixids=9.2.2.0-IBM-MQC-LinuxX64&amp;includeSupersedes=0&amp;source=fc">https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%2FWebSphere&amp;product=ibm/WebSphere/WebSphere+MQ&amp;release=9.2.1&amp;platform=All&amp;function=fixId&amp;fixids=9.2.2.0-IBM-MQC-LinuxX64&amp;includeSupersedes=0&amp;source=fc</a></p></li>
</ul>
<p><strong>Once downloaded and uploaded to the server, extract the tarball archive, accept the license and install the packages, example for CentOS / RHEL:</strong></p>
<p><em>Accept the license first:</em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">MQClient</span><span class="o">/</span><span class="n">mqlicense</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p><em>Then install the RPMs:</em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rpm</span> <span class="o">-</span><span class="n">Uvh</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">MQClient</span><span class="o">/</span><span class="n">MQ</span><span class="o">*.</span><span class="n">rpm</span>
</pre></div>
</div>
</div>
<div class="section" id="q-command-installation">
<h3>Q command installation<a class="headerlink" href="#q-command-installation" title="Permalink to this headline">¶</a></h3>
<p>The Q command is a low level MQ utility which is now a paying product. (See: <a class="reference external" href="https://www.mqgem.com/q.html">https://www.mqgem.com/q.html</a>)</p>
<p>However, a free to earlier version is available and already in use at DHL for the manual submission to MQ, this binary utility is the one that is going to be used at DHL for the deployment of the application.</p>
<p>Make sure this command is available on the machine, its path is configurable within the UI of the Add-on, by convention it could be placed in the following directory: (which is the default directory used by the application and the default directory of the MQClient)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">mqm</span>
</pre></div>
</div>
<p>This path can be customised if needed in the configuration UI of the Add-on:</p>
<a class="reference internal image-reference" href="_images/q_command_path.png"><img alt="q_command_path.png" class="align-center" src="_images/q_command_path.png" style="width: 600px;" /></a>
</div>
<div class="section" id="kvstore-instance">
<h3>KVstore instance<a class="headerlink" href="#kvstore-instance" title="Permalink to this headline">¶</a></h3>
<a class="reference internal image-reference" href="_images/kvstore_instance.png"><img alt="kvstore_instance.png" class="align-center" src="_images/kvstore_instance.png" style="width: 600px;" /></a>
<p>This setting setting the target of the KVstore instance via the Splunk API (splunkd), in the case of a consumer, this should reflect the SHC target as:</p>
<p><code class="docutils literal notranslate"><span class="pre">&lt;address</span> <span class="pre">or</span> <span class="pre">IP&gt;</span></code>:<code class="docutils literal notranslate"><span class="pre">&lt;port</span> <span class="pre">number&gt;</span></code></p>
<p>As soon as this value is not equal to <code class="docutils literal notranslate"><span class="pre">localhost</span></code>, the consumer acts as client from the SHC. (opposed to a standalone consumer)</p>
<p><strong>This setting should be modified only for consumers, not for the SHC members.</strong></p>
</div>
<div class="section" id="bearer-token">
<h3>Bearer token<a class="headerlink" href="#bearer-token" title="Permalink to this headline">¶</a></h3>
<a class="reference internal image-reference" href="_images/bearer_token.png"><img alt="bearer_token.png" class="align-center" src="_images/bearer_token.png" style="width: 600px;" /></a>
<p>This settings contains the bearer token used for a remote authentication to the Splunk API, it is stored encrypted in the Splunk crendential store and used as soon as the KVstore instance value differs from <code class="docutils literal notranslate"><span class="pre">localhost</span></code></p>
<p>On the SHC side, the bearer token should provide all relevant accesses and permissions to the different KVstore handled by the Add-on.</p>
</div>
<div class="section" id="high-availability-group">
<h3>High availability group<a class="headerlink" href="#high-availability-group" title="Permalink to this headline">¶</a></h3>
<a class="reference internal image-reference" href="_images/ha_group_config.png"><img alt="ha_group_config.png" class="align-center" src="_images/ha_group_config.png" style="width: 600px;" /></a>
<p>This settings defines the High availability group for the consumer:</p>
<ul class="simple">
<li><p>A string idenfitier used for high availability purposes</p></li>
<li><p>The idenfitier can be anything of your choice, however using a meanful naming convention is recommended</p></li>
<li><p>When two or more consumers are members of the same High availability group, the SHC automatically elects a manager for the whole group</p></li>
<li><p>The elected manager is the only consumer that will be allowed to consume messages to be processed, other remain pending as long as they are followers</p></li>
<li><p>If the manager does not sent a keep alive Metadata to the SHC in a short period of time (5 minutes), the SHC re-elects a new member based on the available members</p></li>
<li><p>If there are not any active member left in the HA group, none of the consumers of the group can consume messages any longer</p></li>
</ul>
<p>If the setting is not set, the consumer acts as a standalone consumer, and will attempt to consume whatever messages the KVstore search filter allow it to access.</p>
<p>The concept of High Availability is explained in details in the dedicated documentation page.</p>
</div>
<div class="section" id="kvstore-search-filters">
<h3>KVstore search filters<a class="headerlink" href="#kvstore-search-filters" title="Permalink to this headline">¶</a></h3>
<a class="reference internal image-reference" href="_images/kvstore_search_filters.png"><img alt="kvstore_search_filters.png" class="align-center" src="_images/kvstore_search_filters.png" style="width: 600px;" /></a>
<p>This consumer level setting allows to restrict the scope of a specific Heavy Forwarder. (or multiple Heavy Forwarders configured in the same High Availability group)</p>
<p>Use this setting for scaling purposes, allowing to dedicate the consumers to a specific application and/or regional scope.</p>
<p>The filters are translated to a proper Splunk search when accessing to the KVstore, and can be defined including of the fields available in the KVstore collection.</p>
<p>Only a single active Heavy Forwarder should be consuming the records at the same time, this means the rule filters need to be unique on a per high availability group, using the various Metadata available in the KVstore.</p>
<p>The two main Metadata are the “region” and the “appname”, however it is as well possible to add filters based on the queue managers or the queues by adding the relevant filters.</p>
<p><strong>Example:</strong></p>
<p>Let’s assume we address 4 MQ managers, deployed amonst 2 regions and serving 2 applications (1 per region), each region has two Splunk Heavy Forwarders for HA purposes, as follows:</p>
<ul class="simple">
<li><p>region1: EMEA, MQ managers: MQ1 / MQ2, application: buttercup-emea</p></li>
<li><p>region2: AMER, MQ managers: MQ3 / MQ3, application: buttercup-emea</p></li>
</ul>
<p>The configuration of the HA group and the KVstore search filter would be:</p>
<p><em>region1: EMEA</em></p>
<ul class="simple">
<li><p>HA group: <code class="docutils literal notranslate"><span class="pre">HA-GRP-EMEA</span></code></p></li>
<li><p>KVstore filter: <code class="docutils literal notranslate"><span class="pre">(region=&quot;EMEA&quot;</span> <span class="pre">appname=&quot;buttercup-emea&quot;)</span></code></p></li>
</ul>
<p><em>region2: EMEA</em></p>
<ul class="simple">
<li><p>HA group: <code class="docutils literal notranslate"><span class="pre">HA-GRP-EMEA</span></code></p></li>
<li><p>KVstore filter: <code class="docutils literal notranslate"><span class="pre">(region=&quot;EMEA&quot;</span> <span class="pre">appname=&quot;buttercup-emea&quot;)</span></code></p></li>
</ul>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="configuration.html" class="btn btn-neutral float-right" title="MQ managers Configuration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="requirements.html" class="btn btn-neutral float-left" title="Requirements" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, DHL.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>